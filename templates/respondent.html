{# templates/respondents.html #}
{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
{% endblock %}
{% block content %}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Respondents</h1> 
    <div class="d-flex align-items-center gap-2"> 
         
        <button id="btnRunStress" class="btn btn-primary mr-2">Run Stress</button> 
        <a href="/run-model/stress" class="btn btn-secondary">Run Stress Model</a> 
      </div>
</div>

<div class="row"> 
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Daftar Responden</h6>
            </div>
            <div class="card-body">
                <div id="stressResult" class="alert alert-info d-none"></div>
                <div class="table-responsive">
                    <table class="table table-bordered" id="respondentsTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Email</th>
                                <th>Nama</th>
                                <th>Gender</th>
                                <th>Universitas</th>
                                <th>Jurusan</th>
                                <th>Semester</th>
                                <th>Tanggal</th>
                                <th>Stress Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for res in respondents %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ res.email }}</td>
                                <td>{{ res.name }}</td>
                                <td>{{ res.gender }}</td>
                                <td>{{ res.universitas }}</td>
                                <td>{{ res.jurusan }}</td>
                                <td>{{ res.semester }}</td>
                                <td>{{ res.datetime.strftime('%Y-%m-%d %H:%M') if res.datetime else '-' }}</td>
                                <td>{{ res.stress_level or 'Belum diprediksi' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div> 
</div>
 
{% endblock %}

{% block scripts %}  
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
<script>
    $(document).ready(function () {
        $('#respondentsTable').DataTable();
    });
</script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
<script>
$(document).ready(function () {
    $('#respondentsTable').DataTable();

    $('#btnRunStress').on('click', function () {
        const btn = $(this);
        btn.prop('disabled', true).text('Running...');

        fetch('/run-stress')
            .then(response => response.json())
            .then(data => {
                // location.reload();
                let html = '';
                if (data.error) {
                    html = `<strong>Error:</strong> ${data.error}`;
                    $('#stressResult').removeClass('alert-info').addClass('alert-danger');
                } else {
                    html = `
                        <strong>âœ… Model berhasil dijalankan:</strong><br>
                        Akurasi: <strong>${data.accuracy}</strong><br>
                        MAE: ${data.mae}<br>
                        RMSE: ${data.rmse}<br>
                        Data Latih: ${data.train_data}, Data Uji: ${data.test_data}
                    `;
                    $('#stressResult').removeClass('alert-danger').addClass('alert-info');
                }

                $('#stressResult').html(html).removeClass('d-none');
                btn.prop('disabled', false).text('Run Stress');
            })
            .catch(err => {
                $('#stressResult')
                    .html(`<strong>Terjadi kesalahan:</strong> ${err}`)
                    .removeClass('d-none')
                    .removeClass('alert-info')
                    .addClass('alert-danger');
                btn.prop('disabled', false).text('Run Stress');
            });
    });
});
</script>

{% endblock %}
