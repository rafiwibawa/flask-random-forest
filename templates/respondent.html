{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
{% endblock %}

{% block content %}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Respondents</h1> 
    <div class="d-flex align-items-center gap-2"> 
        <button id="btnRunStress" class="btn btn-primary mr-2">Run Stress</button> 
        <a href="/run-model/stress" class="btn btn-secondary">Run Stress Model</a> 
    </div>
</div>

{# ðŸ”¹ FLASH MESSAGES #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="row"> 
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Daftar Responden</h6>
            </div>
            <div class="card-body">
                <div id="stressResult" class="alert alert-info d-none"></div>
                <div id="chartContainer" style="width: 100%; max-width: 500px; height: 450px; margin: auto; display: none;">
                    <canvas id="confusionMatrixChart"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered" id="respondentsTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Email</th>
                                <th>Nama</th>
                                <th>Gender</th>
                                <th>Universitas</th>
                                <th>Jurusan</th>
                                <th>Semester</th>
                                <th>Tanggal</th>
                                <th>Stress Level</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for res in respondents %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ res.email }}</td>
                                <td>{{ res.name }}</td>
                                <td>{{ res.gender }}</td>
                                <td>{{ res.universitas }}</td>
                                <td>{{ res.jurusan }}</td>
                                <td>{{ res.semester }}</td>
                                <td>{{ res.datetime.strftime('%Y-%m-%d %H:%M') if res.datetime else '-' }}</td>
                                <td>{{ res.stress_level or 'Belum diprediksi' }}</td>
                                <td>
                                    <a href="{{ url_for('bp_respondent.deleted', id=res.id) }}" 
                                        class="btn btn-sm btn-danger"
                                        onclick="return confirm('Yakin ingin menghapus data ini?')">
                                        Delete
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div> 
</div>
 
{% endblock %}

{% block scripts %}  
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.3.0/dist/chartjs-chart-matrix.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
    $(document).ready(function () {
        $('#respondentsTable').DataTable();

        $('#btnRunStress').on('click', function () {
            const btn = $(this);
            btn.prop('disabled', true).text('Running...');

            fetch('/run-stress')
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data.error) {
                        html = `<strong>Error:</strong> ${data.error}`;
                        $('#stressResult').removeClass('alert-info').addClass('alert-danger');
                    } else {
                        if (data.confusion_matrix && data.labels) {
                            const ctx = document.getElementById('confusionMatrixChart').getContext('2d');

                            if (window.cmChart) {
                                window.cmChart.destroy();
                            }

                            const matrix = data.confusion_matrix;
                            const labels = data.labels;
                            const heatmapData = [];
                            const maxValue = Math.max(...matrix.flat());

                            for (let i = 0; i < matrix.length; i++) {
                                for (let j = 0; j < matrix[i].length; j++) {
                                    heatmapData.push({
                                        x: labels[j],
                                        y: labels[i],
                                        v: matrix[i][j]
                                    });
                                }
                            }

                            const config = {
                                type: 'matrix',
                                data: {
                                    datasets: [{
                                        label: 'Confusion Matrix',
                                        data: heatmapData,
                                        backgroundColor(ctx) {
                                            const value = ctx.dataset.data[ctx.dataIndex].v;
                                            const alpha = value / maxValue;
                                            return `rgba(54, 162, 235, ${alpha || 0.05})`;
                                        },
                                        borderColor: 'rgba(255,255,255,0.8)',
                                        borderWidth: 1,
                                        width(ctx) {
                                            const chart = ctx.chart;
                                            return chart.chartArea
                                                ? (chart.chartArea.width / labels.length) - 2
                                                : 0;
                                        },
                                        height(ctx) {
                                            const chart = ctx.chart;
                                            return chart.chartArea
                                                ? (chart.chartArea.height / labels.length) - 2
                                                : 0;
                                        }
                                    }]
                                },
                                options: {
                                    maintainAspectRatio: false,
                                    responsive: true,
                                    plugins: {
                                        legend: { display: false },
                                        title: {
                                            display: true,
                                            text: 'Confusion Matrix',
                                            font: { size: 16 }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                title: ctx => `True: ${ctx[0].raw.y}`,
                                                label: ctx => `Pred: ${ctx.raw.x}, Value: ${ctx.raw.v}`
                                            }
                                        },
                                        datalabels: {
                                            color: '#000',
                                            font: { weight: 'bold' },
                                            formatter: (value, ctx) => {
                                                const v = ctx.dataset.data[ctx.dataIndex].v;
                                                return v > 0 ? v : '';  
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            type: 'category',
                                            labels: labels,
                                            title: { display: true, text: 'Predicted label' },
                                            grid: { display: false },
                                            offset: true
                                        },
                                        y: {
                                            type: 'category',
                                            labels: labels.slice().reverse(),
                                            title: { display: true, text: 'True label' },
                                            grid: { display: false },
                                            offset: true
                                        }
                                    }
                                },
                                plugins: [ChartDataLabels]
                            };


                            document.getElementById('chartContainer').style.display = 'block';
                            window.cmChart = new Chart(ctx, config);
                        }


                        html = `
                            <strong>âœ… Model berhasil dijalankan:</strong><br>
                            Akurasi: <strong>${data.accuracy}</strong><br>
                            MAE: ${data.mae}<br>
                            RMSE: ${data.rmse}<br>
                            Data Latih: ${data.train_data}, Data Uji: ${data.test_data}
                        `;
                        $('#stressResult').removeClass('alert-danger').addClass('alert-info');
                    }

                    $('#stressResult').html(html).removeClass('d-none');
                    btn.prop('disabled', false).text('Run Stress');
                })
                .catch(err => {
                    $('#stressResult')
                        .html(`<strong>Terjadi kesalahan:</strong> ${err}`)
                        .removeClass('d-none')
                        .removeClass('alert-info')
                        .addClass('alert-danger');
                    btn.prop('disabled', false).text('Run Stress');
                });
        });
    });
</script>
{% endblock %}
